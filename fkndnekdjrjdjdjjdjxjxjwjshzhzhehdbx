local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- ส่วนที่ 1: เก็บไอเท็มระยะไกล
-- การตั้งค่าระยะและความเร็ว
local DETECTION_RANGE = 17 -- ระยะตรวจจับไอเท็ม 17 หน่วย (ปรับตามคำขอ)
local MAGNET_SPEED = 900 -- ความเร็วที่ไอเท็มถูกดูด
local PICKUP_ZONE_SIZE = 17 -- ขนาดของ PickUpZone

-- ฟังก์ชันปรับขนาด PickUpZone
local function adjustPickUpZone(instance)
    local pickUpZone = instance:FindFirstChild("PickUpZone")
    if pickUpZone and pickUpZone:IsA("BasePart") then
        pickUpZone.Size = Vector3.new(PICKUP_ZONE_SIZE, PICKUP_ZONE_SIZE, PICKUP_ZONE_SIZE)
        pickUpZone.CanCollide = false
        pickUpZone.Transparency = 1
    end
end

-- ฟังก์ชันดูดและเก็บไอเท็ม
local function handleItem(item)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return -- ออกถ้าตัวละครหรือ HumanoidRootPart ไม่มี
    end
    local targetPos = character.HumanoidRootPart.Position
    local currentPos = item:GetPivot().Position
    local distance = (targetPos - currentPos).Magnitude
    if distance <= DETECTION_RANGE then
        -- ดูดไอเท็ม
        local direction = (targetPos - currentPos).Unit * MAGNET_SPEED * 0.0000000000001
        item:PivotTo(item:GetPivot() + direction)
        -- เก็บไอเท็ม
        local remote = ReplicatedStorage:FindFirstChild("pickup_dropped_item")
        if remote then
            remote:FireServer(item)
        else
            warn("ไม่พบ Remote Event: pickup_dropped_item")
        end
    end
end

-- ตรวจจับไอเท็มใน Workspace
RunService.Heartbeat:Connect(function()
    for _, item in pairs(workspace:GetChildren()) do
        if item:FindFirstChild("PickUpZone") then
            adjustPickUpZone(item)
            handleItem(item)
        end
    end
end)

-- ตรวจจับไอเท็มที่เพิ่มเข้ามาใหม่
workspace.DescendantAdded:Connect(function(instance)
    if instance.Name == "PickUpZone" then
        adjustPickUpZone(instance.Parent)
    end
end)
